# Axolotly Android Launcher API Documentation

**Version:** 1.0  
**Base URL:** `https://axolotly.replit.app`  
**Last Updated:** December 2024

---

## Table of Contents

1. [Authentication](#authentication)
2. [Device Pairing](#device-pairing)
3. [Content Retrieval](#content-retrieval)
4. [Usage Tracking](#usage-tracking)
5. [Error Handling](#error-handling)
6. [Data Models](#data-models)

---

## Authentication

### Device Authentication

After successful pairing, all authenticated requests require these headers:

```
X-Device-Id: {device_id}
X-Api-Key: {api_key}
```

Both values are returned from the pairing endpoint.

---

## Device Pairing

### Option 1: Simple Pairing (Recommended)

#### POST `/api/pair`

Pair a device using a 6-digit code generated by the parent in the dashboard.

**Request:**
```json
{
  "pairingCode": "123456"
}
```

**Success Response (200):**
```json
{
  "deviceId": "abc123xyz...",
  "apiKey": "secure_api_key_here...",
  "familyName": "Smith"
}
```

**Error Responses:**

| Status | Response | Meaning |
|--------|----------|---------|
| 400 | `{"detail": "Invalid pairing code format"}` | Code must be exactly 6 digits |
| 401 | `{"detail": "Invalid or expired pairing code"}` | Code not found or expired |

---

### Option 2: 3-Step Pairing Flow

For more control over the pairing process:

#### Step 1: POST `/api/pairing/initiate`

Device initiates pairing by displaying a code to the user.

**Request:**
```json
{
  "device_id": "unique_android_device_id",
  "pairing_code": "123456"
}
```

**Success Response (200):**
```json
{
  "status": "pending_confirmation"
}
```

**Error Responses:**

| Status | Response |
|--------|----------|
| 400 | `{"detail": "device_id and pairing_code required"}` |
| 400 | `{"detail": "pairing_code must be 6 digits"}` |
| 409 | `{"detail": "Pairing code already in use"}` |

---

#### Step 2: GET `/api/pairing/status/{device_id}`

Poll this endpoint to check if parent has confirmed pairing.

**Response (Not Yet Paired):**
```json
{
  "is_paired": false,
  "api_key": null
}
```

**Response (Paired Successfully):**
```json
{
  "is_paired": true,
  "api_key": "secure_api_key_here..."
}
```

**Polling Recommendation:** Every 2-3 seconds, timeout after 5 minutes.

---

#### Step 3: Parent Confirms (Dashboard Side)

Parent enters the 6-digit code in their dashboard. This is handled by the web app, not the Android launcher.

---

### Validate Existing Credentials

#### GET `/api/device/validate`

Check if saved credentials are still valid.

**Headers Required:**
```
X-Device-Id: {device_id}
X-Api-Key: {api_key}
```

**Success Response (200):**
```json
{
  "is_paired": true,
  "kid_profile_id": 42,
  "kid_name": "Emma",
  "kid_age": 8
}
```

**Error Response (401):**
```json
{
  "detail": "Invalid device credentials"
}
```

---

## Content Retrieval

### GET `/api/apps`

Get all approved content for this device's linked kid profile.

**Headers Required:**
```
X-Device-Id: {device_id}
X-Api-Key: {api_key}
```

**Success Response (200):**
```json
[
  {
    "id": "netflix",
    "name": "Netflix",
    "package": "com.netflix.mediaclient",
    "content": [
      {
        "id": "123",
        "appName": "Bluey",
        "packageName": "com.disney.disneyplus",
        "iconUrl": "https://image.tmdb.org/t/p/w500/poster.jpg",
        "coverArt": "https://image.tmdb.org/t/p/w780/backdrop.jpg",
        "isEnabled": true,
        "ageRating": "TV-Y",
        "mediaType": "TV",
        "deepLink": "https://www.disneyplus.com/series/bluey/...",
        "episodes": [
          {
            "id": "s1e1",
            "name": "Magic Xylophone",
            "deepLink": "disneyplus://playback/..."
          }
        ]
      }
    ],
    "count": 15
  },
  {
    "id": "disney_plus",
    "name": "Disney+",
    "package": "com.disney.disneyplus",
    "content": [...],
    "count": 8
  }
]
```

**Content Item Fields:**

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Unique content ID |
| `appName` | string | Title name |
| `packageName` | string | Android package for launching |
| `iconUrl` | string | Poster image URL (500px width) |
| `coverArt` | string | Backdrop image URL (780px width) |
| `isEnabled` | boolean | Always `true` for approved content |
| `ageRating` | string | Content rating (G, PG, TV-Y, etc.) |
| `mediaType` | string | "TV" or "MOVIE" |
| `deepLink` | string | Series-level deep link |
| `episodes` | array | (TV only) Episode array with deep links |

**Episode Object:**

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Episode ID (format: "s1e1") |
| `name` | string | Episode name |
| `deepLink` | string | Direct episode deep link |

---

### GET `/api/time-limits`

Get screen time configuration for this device.

**Headers Required:**
```
X-Device-Id: {device_id}
X-Api-Key: {api_key}
```

**Response (200):**
```json
{
  "dailyLimitMinutes": 120,
  "bedtimeStart": "20:00",
  "bedtimeEnd": "07:00",
  "scheduleEnabled": true
}
```

**Response (No Limits Set):**
```json
{
  "dailyLimitMinutes": null,
  "bedtimeStart": null,
  "bedtimeEnd": null,
  "scheduleEnabled": false
}
```

---

### GET `/api/stats`

Get usage statistics for this device.

**Headers Required:**
```
X-Device-Id: {device_id}
X-Api-Key: {api_key}
```

**Response (200):**
```json
{
  "totalAppsEnabled": 25,
  "timeUsedToday": 45,
  "timeRemainingToday": 75,
  "mostUsedApp": "Bluey"
}
```

---

## Usage Tracking

### POST `/api/usage-logs`

Log content usage for analytics.

**Headers Required:**
```
X-Device-Id: {device_id}
X-Api-Key: {api_key}
```

**Request:**
```json
{
  "appId": "123",
  "appName": "Bluey",
  "startTime": "2024-12-17T10:30:00Z",
  "endTime": "2024-12-17T11:00:00Z",
  "durationMinutes": 30
}
```

**Success Response (200):**
```json
{
  "success": true
}
```

---

### POST `/api/device/episode-report`

Report a discovered deep link for crowdsourcing.

**Headers Required:**
```
X-Device-Id: {device_id}
X-Api-Key: {api_key}
```

**Request:**
```json
{
  "title_id": 123,
  "season_number": 2,
  "episode_number": 5,
  "deep_link_url": "disneyplus://playback/abc123",
  "streaming_service": "disney_plus"
}
```

**Success Response (200):**
```json
{
  "success": true,
  "message": "Episode report saved"
}
```

---

## Error Handling

### Standard Error Format

All errors return JSON with a `detail` field:

```json
{
  "detail": "Error message here"
}
```

### Common HTTP Status Codes

| Status | Meaning |
|--------|---------|
| 200 | Success |
| 400 | Bad Request - Invalid parameters |
| 401 | Unauthorized - Invalid or missing credentials |
| 403 | Forbidden - Not allowed for this device/profile |
| 404 | Not Found - Resource doesn't exist |
| 410 | Gone - Resource expired (e.g., pairing code) |
| 500 | Server Error |
| 503 | Service Unavailable - Server starting up (retry in 3-5 seconds) |

### Handling 503 Errors (Cold Starts)

The server uses autoscale deployment which may have cold starts. When you receive a 503:

```kotlin
// Kotlin example
suspend fun fetchWithRetry(url: String, maxRetries: Int = 3): Response {
    repeat(maxRetries) { attempt ->
        val response = httpClient.get(url)
        if (response.status.value != 503) {
            return response
        }
        delay(3000) // Wait 3 seconds before retry
    }
    throw Exception("Server unavailable after $maxRetries attempts")
}
```

---

## Data Models

### Device Credentials (Store Securely)

```kotlin
data class DeviceCredentials(
    val deviceId: String,
    val apiKey: String
)
```

### Content Category

```kotlin
data class ContentCategory(
    val id: String,
    val name: String,
    val packageName: String,
    val content: List<ContentItem>,
    val count: Int
)
```

### Content Item

```kotlin
data class ContentItem(
    val id: String,
    val appName: String,
    val packageName: String,
    val iconUrl: String,
    val coverArt: String,
    val isEnabled: Boolean,
    val ageRating: String,
    val mediaType: String,
    val deepLink: String,
    val episodes: List<Episode>? = null
)
```

### Episode

```kotlin
data class Episode(
    val id: String,
    val name: String,
    val deepLink: String
)
```

---

## Quick Reference

### All Endpoints

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| POST | `/api/pair` | None | Simple 6-digit pairing |
| POST | `/api/pairing/initiate` | None | Start 3-step pairing |
| GET | `/api/pairing/status/{device_id}` | None | Check pairing status |
| GET | `/api/device/validate` | Device | Validate saved credentials |
| GET | `/api/apps` | Device | Get approved content |
| GET | `/api/time-limits` | Device | Get screen time limits |
| GET | `/api/stats` | Device | Get usage stats |
| POST | `/api/usage-logs` | Device | Log usage |
| POST | `/api/device/episode-report` | Device | Report deep link |

### Streaming Service Package Names

| Service | Package Name |
|---------|--------------|
| Netflix | `com.netflix.mediaclient` |
| Disney+ | `com.disney.disneyplus` |
| Hulu | `com.hulu.plus` |
| Prime Video | `com.amazon.avod.thirdpartyclient` |
| Peacock | `com.peacocktv.peacockandroid` |
| YouTube | `com.google.android.youtube` |

---

## Support

For API issues or questions, contact the backend development team.
